clear;
%初始化
a1=35+3;a2=35+3;a3=35+3;a4=15+3;%%%%%%%
d = 2; lf = 40;
t = [0;-pi/2;0;0;0;0];
%t = [0;0;0;0;0;0];
time = 0;
dt = 0.01;
tmax = 10;
m = [2.7*a1*d*d,2.7*a1*d*d,2.7*a1*d*d,0,0,2.7*a4*d*d,2.7*lf^3];%%%%%%%%%%%%
I00 = eye(3)*m(7)*lf^2/6;
%%%%%%%
I01 = [m(1)*(d^2+d^2)/12,0,0;
    0,m(1)*(a1^2+d^2)/12+m(1)*(a1/2)^2,0;
    0,0,m(1)*(a1^2+d^2)/12+m(1)*(a1/2)^2];
I02 = [m(6)*(d^2+d^2)/12,0,0;
    0,m(6)*(a1^2+d^2)/12+m(6)*(a1/2)^2,0;
    0,0,m(6)*(a1^2+d^2)/12+m(6)*(a1/2)^2];
r = zeros(7,3);
r(7,:) = [150,-30,40];%%%%%%%%%%%%%%%%
[posend,T0,T1,T2,T3,T4,T5,T6] = spaceforward(r(7,1),r(7,2),r(7,3),0,0,0,t);
tmp = T0*[20;0;0;1];
p(1,:) = tmp(1:3);
tmp = T0*T1*[a1;0;0;1];
p(2,:) = tmp(1:3);
tmp = T0*T1*T2*[a2;0;0;1];
p(3,:) = tmp(1:3);
tmp = T0*T1*T2*T3*[a3;0;0;1];
p(4,:) = tmp(1:3);
p(5,:) = p(4,:);
p(6,:) = p(4,:);
tmp = T0*T1*T2*T3*T4*T5*T6*[a4;0;0;1];
re = tmp(1:3);
r(1,:) = (p(1,:)+p(2,:))/2;
r(2,:) = (p(2,:)+p(3,:))/2;
r(3,:) = (p(4,:)+p(3,:))/2;
r(4,:) = (p(4,:)+p(5,:))/2;
r(5,:) = (p(6,:)+p(5,:))/2;
r(6,:) = (p(6,:)+re.')/2;
%基座姿态，位置
a = 0; b = 0; c = 0;
x = r(7,1); y = r(7,2); z = r(7,3);
%k,I
tmp = T0*T1*[0;0;1;1];
k(1,:) = tmp(1:3)-p(1,:).';
tmp = T0*T1*T2*[0;0;1;1];
k(2,:) = tmp(1:3)-p(2,:).';
tmp = T0*T1*T2*T3*[0;0;1;1];
k(3,:) = tmp(1:3)-p(3,:).';
tmp = T0*T1*T2*T3*T4*[0;0;1;1];
k(4,:) = tmp(1:3)-p(4,:).';
tmp = T0*T1*T2*T3*T4*T5*[0;0;1;1];
k(5,:) = tmp(1:3)-p(5,:).';
tmp = T0*T1*T2*T3*T4*T5*T6*[0;0;1;1];
k(6,:) = tmp(1:3)-p(6,:).';
R0 = T0(1:3,1:3);
R1 = T0(1:3,1:3)*T1(1:3,1:3);
R2 = T0(1:3,1:3)*T1(1:3,1:3)*T2(1:3,1:3);
R3 = T0(1:3,1:3)*T1(1:3,1:3)*T2(1:3,1:3)*T3(1:3,1:3);
R4 = T0(1:3,1:3)*T1(1:3,1:3)*T2(1:3,1:3)*T3(1:3,1:3)*T4(1:3,1:3);
R5 = T0(1:3,1:3)*T1(1:3,1:3)*T2(1:3,1:3)*T3(1:3,1:3)*T4(1:3,1:3)*T5(1:3,1:3);
R6 = T0(1:3,1:3)*T1(1:3,1:3)*T2(1:3,1:3)*T3(1:3,1:3)*T4(1:3,1:3)*T5(1:3,1:3)*T6(1:3,1:3);
I(7,:,:) = R0*I00*R0.';
I(1,:,:) = R1*I01*R1.';
I(2,:,:) = R2*I01*R2.';
I(3,:,:) = R3*I01*R3.';
I(4,:,:) = zeros(3,3);
I(5,:,:) = zeros(3,3);
I(6,:,:) = R6*I02*R6.';
desp = [250;0;35];
tv = [0;0;0;0;0;0];
tvg = [0;0;0;0;0;0];
ov = [0;0;0;0;0;0];
M = sum(m);
MaxIter = 1299;
trecord = [0;-1.31;0;0;0;0];
tvrecord = [0;0;0;0;0;0];
for i = 1:MaxIter*dt/dt
    rg = [0,0,0];
    [J,Jbm] = Jacobbm(re,t,m,r,I,k,p,a,b,c);%jacob矩阵计算
    ve = (desp-re);%;/norm(desp-re);
    w0 = [0;0;0];
    tv = J\[ve;w0];
    %tv = [0.1571;0.1571;0.1571;0.;0.;0.];
    for j = 1:3
        if abs(tv(j))>1
            tvg(j) = 1*tv(j)/abs(tv(j));
        else
            tvg(j) = tv(j);
        end
    end%防止奇异发散
    if max([tv(4),tv(5),tv(6)])>1
        tvg(4) = 2*tv(4)/norm([tv(4);tv(5);tv(6)]);
        tvg(5) = 2*tv(5)/norm([tv(4);tv(5);tv(6)]);
        tvg(6) = 2*tv(6)/norm([tv(4);tv(5);tv(6)]);
    end
    %计算质心坐标
    for j = 1:7
        rg = rg + r(j,:)*m(j);
    end
    rg = rg/M;
    re.'
    tv.'
    ov = Jbm*tvg;
    t = t+tvg*dt;
    trecord = [trecord,t];
    tvrecord = [tvrecord,tvg];
    a = a+ov(4)*dt; b = b+ov(5)*dt; c = c+ov(6)*dt;
    x = x+ov(1)*dt; y = y+ov(2)*dt; z = z+ov(3)*dt;
    r(7,1) = x;
    r(7,2) = y;
    r(7,3) = z;
    [posend,T0,T1,T2,T3,T4,T5,T6] = spaceforward(r(7,1),r(7,2),r(7,3),a,b,c,t);
    tmp = T0*[lf/2;0;0;1];
    p(1,:) = tmp(1:3);
    tmp = T0*T1*[a1;0;0;1];
    p(2,:) = tmp(1:3);
    tmp = T0*T1*T2*[a2;0;0;1];
    p(3,:) = tmp(1:3);
    tmp = T0*T1*T2*T3*[a3;0;0;1];
    p(4,:) = tmp(1:3);
    p(5,:) = p(4,:);
    p(6,:) = p(4,:);
    tmp = T0*T1*T2*T3*T4*T5*T6*[a4;0;0;1];
    re = tmp(1:3);
    r(1,:) = (p(1,:)+p(2,:))/2;
    r(2,:) = (p(2,:)+p(3,:))/2;
    r(3,:) = (p(4,:)+p(3,:))/2;
    r(4,:) = (p(4,:)+p(5,:))/2;
    r(5,:) = (p(6,:)+p(5,:))/2;
    r(6,:) = (p(6,:)+re.')/2;
    %k,I
    tmp = T0*T1*[0;0;1;1];
    k(1,:) = tmp(1:3)-p(1,:).';
    tmp = T0*T1*T2*[0;0;1;1];
    k(2,:) = tmp(1:3)-p(2,:).';
    tmp = T0*T1*T2*T3*[0;0;1;1];
    k(3,:) = tmp(1:3)-p(3,:).';
    tmp = T0*T1*T2*T3*T4*[0;0;1;1];
    k(4,:) = tmp(1:3)-p(4,:).';
    tmp = T0*T1*T2*T3*T4*T5*[0;0;1;1];
    k(5,:) = tmp(1:3)-p(5,:).';
    tmp = T0*T1*T2*T3*T4*T5*T6*[0;0;1;1];
    k(6,:) = tmp(1:3)-p(6,:).';
    R0 = T0(1:3,1:3);
    R1 = T0(1:3,1:3)*T1(1:3,1:3);
    R2 = T0(1:3,1:3)*T1(1:3,1:3)*T2(1:3,1:3);
    R3 = T0(1:3,1:3)*T1(1:3,1:3)*T2(1:3,1:3)*T3(1:3,1:3);
    Rf = T0(1:3,1:3)*T1(1:3,1:3)*T2(1:3,1:3)*T3(1:3,1:3)*T4(1:3,1:3)*T5(1:3,1:3)*T6(1:3,1:3);
    I(7,:,:) = R0*I00*R0.';
    I(1,:,:) = R1*I01*R1.';
    I(2,:,:) = R2*I01*R2.';
    I(3,:,:) = R3*I01*R3.';
    I(4,:,:) = zeros(3,3);
    I(5,:,:) = zeros(3,3);
    I(6,:,:) = Rf*I02*Rf.';
    plot3(p(1,1),p(1,2),p(1,3),'mo','MarkerSize',5);
    hold on
    plot3(p(2,1),p(2,2),p(2,3),'mo','MarkerSize',5); 
    hold on
    plot3(p(3,1),p(3,2),p(3,3),'mo','MarkerSize',5); 
    hold on
    plot3(p(4,1),p(4,2),p(4,3),'mo','MarkerSize',5); 
    hold on
    plot3(re(1),re(2),re(3),'mo','MarkerSize',5); 
    hold on
    plot3(x,y,z,'mo','MarkerSize',10)
    plot3([p(4,1),re(1)],[p(4,2),re(2)],[p(4,3),re(3)],'-'); 
    plot3([p(3,1),p(4,1)],[p(3,2),p(4,2)],[p(3,3),p(4,3)],'-'); 
    plot3([p(1,1),p(2,1)],[p(1,2),p(2,2)],[p(1,3),p(2,3)],'-'); 
    plot3([p(3,1),p(2,1)],[p(3,2),p(2,2)],[p(3,3),p(2,3)],'-'); 
    plot3([x,p(1,1)],[y,p(1,2)],[z,p(1,3)],'-'); 
    hold on
    grid on;
    view([10,10,10])
    xlim([20,300])
    ylim([-100,100])
    zlim([0,200])
    hold off
    drawnow
     if norm(re-desp)<0.1
         break
     end
end